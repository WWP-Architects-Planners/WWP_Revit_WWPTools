<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="WW+P Tools Installer"
           Manufacturer="WW+P"
           Version="1.1.8.0"
           UpgradeCode="{F0C6E339-6C9E-4A3A-9D2A-59F8E3D1B8B9}"
           Scope="perUser"
           Compressed="yes">
    <Icon Id="WWPToolsIcon" SourceFile="WWPTools.ico" />
    <Property Id="ARPPRODUCTICON" Value="WWPToolsIcon" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of WWPTools is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <StandardDirectory Id="AppDataFolder">
      <Directory Id="PyRevitDir" Name="pyRevit">
        <Directory Id="ExtensionsDir" Name="Extensions">
          <Directory Id="INSTALLFOLDER" Name="WWPTools.extension" />
        </Directory>
      </Directory>
    </StandardDirectory>
    <Component Id="RegistryMarker" Directory="INSTALLFOLDER" Guid="*">
      <RegistryValue Root="HKCU"
                     Key="Software\\WWP\\WWPTools"
                     Name="Installed"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />
    </Component>
    <Component Id="RegistryMarkerPackagesFeature" Directory="INSTALLFOLDER" Guid="*">
      <RegistryValue Root="HKCU"
                     Key="Software\\WWP\\WWPTools"
                     Name="PackagesFeatureInstalled"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />
    </Component>
    <Feature Id="MainFeature" Title="WWPTools Scripts" Level="1">
      <ComponentRef Id="RegistryMarker" />
    </Feature>
    <Feature Id="PackagesFeature" Title="Dynamo Packages" Description="Install Dynamo packages to C:\\dynpackages and register the path in Dynamo settings." Level="2">
      <ComponentRef Id="RegistryMarkerPackagesFeature" />
    </Feature>

    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="WWPTools-banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="WWPTools-dialog.png" />
    <UI>
      <ui:WixUI Id="WixUI_FeatureTree" />
    </UI>

    <!-- Run the pre-install Revit check at UI time before the actual install executes so the user
         is informed and the install is prevented if Revit is running. This reuses the existing
         SetWixQuietExecCmdLine custom action (which pops up a message and aborts when Revit is found). -->
    <InstallUISequence>
      <Custom Action="SetWixQuietExecCmdLineInstallScripts" Before="ExecuteAction" Condition="NOT REMOVE~=&quot;ALL&quot; AND &amp;PackagesFeature&lt;&gt;3" />
      <Custom Action="SetWixQuietExecCmdLineInstallWithPackages" Before="ExecuteAction" Condition="NOT REMOVE~=&quot;ALL&quot; AND &amp;PackagesFeature=3" />
    </InstallUISequence>

    <Property Id="WixQuietExecCmdLine" Hidden="yes" />
    <CustomAction Id="SetWixQuietExecCmdLineInstallScripts"
                  Property="WixQuietExecCmdLine"
                  Value="&quot;[SystemFolder]WindowsPowerShell\\v1.0\\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -EncodedCommand __WWPTOOLS_PS_INSTALL_BASE64__" />
    <CustomAction Id="SetWixQuietExecCmdLineInstallWithPackages"
                  Property="WixQuietExecCmdLine"
                  Value="&quot;[SystemFolder]WindowsPowerShell\\v1.0\\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -EncodedCommand __WWPTOOLS_PS_INSTALL_WITH_PACKAGES_BASE64__" />
    <CustomAction Id="SetWixQuietExecCmdLineUninstallScripts"
                  Property="WixQuietExecCmdLine"
                  Value="&quot;[SystemFolder]WindowsPowerShell\\v1.0\\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -EncodedCommand __WWPTOOLS_PS_UNINSTALL_BASE64__" />
    <CustomAction Id="SetWixQuietExecCmdLineUninstallWithPackages"
                  Property="WixQuietExecCmdLine"
                  Value="&quot;[SystemFolder]WindowsPowerShell\\v1.0\\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -EncodedCommand __WWPTOOLS_PS_UNINSTALL_WITH_PACKAGES_BASE64__" />
    <CustomActionRef Id="Wix4QuietExec_X64" />

    <InstallExecuteSequence>
      <Custom Action="SetWixQuietExecCmdLineInstallScripts" Before="Wix4QuietExec_X64" Condition="NOT REMOVE~=&quot;ALL&quot; AND &amp;PackagesFeature&lt;&gt;3" />
      <Custom Action="SetWixQuietExecCmdLineInstallWithPackages" Before="Wix4QuietExec_X64" Condition="NOT REMOVE~=&quot;ALL&quot; AND &amp;PackagesFeature=3" />
      <Custom Action="SetWixQuietExecCmdLineUninstallScripts" Before="Wix4QuietExec_X64" Condition="REMOVE~=&quot;ALL&quot; AND !PackagesFeature&lt;&gt;3" />
      <Custom Action="SetWixQuietExecCmdLineUninstallWithPackages" Before="Wix4QuietExec_X64" Condition="REMOVE~=&quot;ALL&quot; AND !PackagesFeature=3" />
      <Custom Action="Wix4QuietExec_X64" After="InstallInitialize" />
    </InstallExecuteSequence>
  </Package>
</Wix>








