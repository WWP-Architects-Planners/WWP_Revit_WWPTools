<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="WW+P Tools Installer"
           Manufacturer="WW+P"
           Version="1.1.2.0"
           UpgradeCode="{F0C6E339-6C9E-4A3A-9D2A-59F8E3D1B8B9}"
           Scope="perUser"
           Compressed="yes">
    <Icon Id="WWPToolsIcon" SourceFile="WWPTools.ico" />
    <Property Id="ARPPRODUCTICON" Value="WWPToolsIcon" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of WWPTools is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <StandardDirectory Id="AppDataFolder">
      <Directory Id="PyRevitDir" Name="pyRevit">
        <Directory Id="ExtensionsDir" Name="Extensions">
          <Directory Id="INSTALLFOLDER" Name="WWPTools.extension" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <Component Id="RegistryMarker" Directory="INSTALLFOLDER" Guid="*">
      <RegistryValue Root="HKCU"
                     Key="Software\\WWP\\WWPTools"
                     Name="Installed"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />
    </Component>

    <Feature Id="MainFeature" Title="WWPTools" Level="1">
      <ComponentRef Id="RegistryMarker" />
    </Feature>

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="WWPTools-banner.bmp" />
    <UI>
      <ui:WixUI Id="WixUI_InstallDir" />
    </UI>

    <Property Id="WixQuietExecCmdLine" Hidden="yes" />
    <CustomAction Id="SetWixQuietExecCmdLine"
                  Property="WixQuietExecCmdLine"
                  Value="&quot;[SystemFolder]WindowsPowerShell\\v1.0\\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$ErrorActionPreference='Stop';# Pre-install Revit check: if any Revit process is running, show a popup and abort installation;$revitProcs = Get-Process -Name 'revit' -ErrorAction SilentlyContinue; if ($revitProcs) { $msg='Please close Revit before installing WWPTools. The installer cannot update files while Revit is running.'; try { $shell=New-Object -ComObject WScript.Shell; $shell.Popup($msg,0,'WWPTools Installer',48)|Out-Null } catch { Write-Host $msg }; throw 'Revit is running, installation aborted.' };$repoOwner='jason-svn';$repoName='WWPTools';$branch='main';$targetPackages='C:\dynpackages';$targetExtension='[INSTALLFOLDER]';$extensionsRoot=Split-Path -Parent $targetExtension;$repoZipUrl='https://github.com/' + $repoOwner + '/' + $repoName + '/archive/refs/heads/' + $branch + '.zip';$tempDir=Join-Path $env:TEMP ('WWPTools_' + (New-Guid).ToString('N'));$zipPath=Join-Path $tempDir ($repoName + '-' + $branch + '.zip');$extractDir=Join-Path $tempDir 'extract';New-Item -ItemType Directory -Path $tempDir | Out-Null;New-Item -ItemType Directory -Path $extractDir | Out-Null;Invoke-WebRequest -Uri $repoZipUrl -OutFile $zipPath -UseBasicParsing;$attempts=0;$maxAttempts=3;while ($attempts -lt $maxAttempts -and -not (Test-Path (Join-Path $extractDir ($repoName + '-' + $branch)))) { $attempts++; try { Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractDir); break } catch { Write-Host ('Zip extraction attempt {0} failed: {1}' -f $attempts, $_.Exception.Message); Start-Sleep -Seconds (2*$attempts); if (Test-Path $zipPath) { Remove-Item $zipPath -Force -ErrorAction SilentlyContinue; Invoke-WebRequest -Uri $repoZipUrl -OutFile $zipPath -UseBasicParsing } } };$repoRoot=Join-Path $extractDir ($repoName + '-' + $branch);$extractedExtension=Join-Path $repoRoot 'WWPTools.extension';if (-not (Test-Path $extractedExtension)) { throw 'Expected WWPTools.extension in the repo zip.' };New-Item -ItemType Directory -Path $extensionsRoot -Force | Out-Null;if (Test-Path $targetExtension) { Remove-Item -Path $targetExtension -Recurse -Force -ErrorAction SilentlyContinue };Copy-Item -Path $extractedExtension -Destination $targetExtension -Recurse -Force;$packagesSource=Join-Path $repoRoot 'packages';if (Test-Path $packagesSource) { New-Item -ItemType Directory -Path $targetPackages -Force | Out-Null;Copy-Item -Path (Join-Path $packagesSource '*') -Destination $targetPackages -Recurse -Force };function Ensure-SettingsFile($settingsPath){ if (Test-Path $settingsPath) { return $false }; $settingsDir=Split-Path -Parent $settingsPath; New-Item -ItemType Directory -Path $settingsDir -Force | Out-Null; $xml=New-Object System.Xml.XmlDocument; $decl=$xml.CreateXmlDeclaration('1.0','utf-8',$null); $xml.AppendChild($decl)|Out-Null; $root=$xml.CreateElement('PreferenceSettings'); $cpf=$xml.CreateElement('CustomPackageFolders'); $root.AppendChild($cpf)|Out-Null; $xml.AppendChild($root)|Out-Null; $xml.Save($settingsPath); return $true };function Add-PackagePath($settingsPath,$packagePath){ if (-not (Test-Path $settingsPath)) { return }; [xml]$xml=Get-Content -Path $settingsPath; $prefs=$xml.PreferenceSettings; if (-not $prefs) { return }; $cpf=$prefs.CustomPackageFolders; if (-not $cpf) { $cpf=$xml.CreateElement('CustomPackageFolders'); $prefs.AppendChild($cpf)|Out-Null }; $existing=@($cpf.string); if ($existing -notcontains $packagePath) { $node=$xml.CreateElement('string'); $node.InnerText=$packagePath; $cpf.AppendChild($node)|Out-Null; $xml.Save($settingsPath) } };$dynamoRoot=Join-Path $env:APPDATA 'Dynamo\Dynamo Revit';$createdSettings=$false;if (Test-Path $dynamoRoot) { Get-ChildItem -Path $dynamoRoot -Directory | ForEach-Object { $settingsPath=Join-Path $_.FullName 'DynamoSettings.xml'; if (Ensure-SettingsFile -settingsPath $settingsPath) { $createdSettings=$true }; Add-PackagePath -settingsPath $settingsPath -packagePath $targetPackages } };if (Test-Path $tempDir) { Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue };if ($createdSettings) { $msg='Dynamo settings were created. Please launch Dynamo once to finish setup.'; try { $shell=New-Object -ComObject WScript.Shell; $shell.Popup($msg,10,'WWPTools',64)|Out-Null } catch { } }&quot;" />
    <CustomActionRef Id="Wix4QuietExec_X64" />

    <InstallExecuteSequence>
      <Custom Action="SetWixQuietExecCmdLine" Before="Wix4QuietExec_X64" Condition="NOT Installed" />
      <Custom Action="Wix4QuietExec_X64" After="InstallFiles" Condition="NOT Installed" />
    </InstallExecuteSequence>
  </Package>
</Wix>





